CREATE OR REPLACE PROCEDURE P_DM_CUST_TRANS_STAT_FREQ
(TABLE_NAME IN VARCHAR2, --表名
  FREQ IN VARCHAR2, --频度
  FREQ_VALUE IN VARCHAR2, --频度值
  DAY_OF_FREQ IN VARCHAR2, --频度中的第几天
  FREQ_HIS IN NUMBER, --频度留存历史期数
  DM_TODAY IN NUMBER,        -- 数据日期"当日"
  DM_YESTERDAY IN NUMBER, -- 数据日期"上一日"
  IO_ROW OUT INTEGER,
  IO_STATUS OUT INTEGER
)

AS

  PROCEDURE_NAME VARCHAR2(125) :='P_'||TABLE_NAME;  -- 存储过程名(修改)

  
  IO_SQLERR VARCHAR2(2000);

  DM_SQL VARCHAR2(30000); -- the variable to loading the SQL statment
  ST_ROW INTEGER;  --源数据条数
  V_START_TIMESTAMP TIMESTAMP;    --the start time of procedures
  V_END_TIMESTAMP   TIMESTAMP;    --the end time of procedures


BEGIN

  IO_ROW := 0;  --插入条数

  SELECT SYSDATE INTO V_START_TIMESTAMP FROM dual;    -- 加载程序运行开始时间

  --恢复'上一日'数据。
  --查询DM层表中是否有"今日"数据，是否为重跑。
  DM_SQL := 'SELECT COUNT(1) FROM MMAPDM.'||TABLE_NAME||' WHERE PERIOD_ID='||DM_TODAY;
  EXECUTE  IMMEDIATE DM_SQL  INTO ST_ROW;
  IF ST_ROW>0
    --如果为重跑数据，则将数据恢复为'前一日'数据状态

      THEN
    --1.删除'今日'数据
    DM_SQL :='DELETE FROM MMAPDM.'||TABLE_NAME||' WHERE PERIOD_ID='||DM_TODAY;
    EXECUTE IMMEDIATE DM_SQL;
    IO_ROW := IO_ROW+SQL%ROWCOUNT ;
    COMMIT;
    --2.恢复频度差
    DM_SQL :='UPDATE MMAPDM.'||TABLE_NAME||' SET FREQ_DIFF = FREQ_DIFF - 1
        WHERE (SELECT '||DAY_OF_FREQ||' FROM MMAPST.MID_CALENDAR WHERE PERIOD_ID='||DM_TODAY||')=1
      ';
    EXECUTE IMMEDIATE DM_SQL;
    IO_ROW := IO_ROW+SQL%ROWCOUNT ;
    COMMIT;
  --3.插入昨日数据
  DM_SQL:= 'INSERT INTO MMAPDM.'||TABLE_NAME||'
      (
      ETL_DATE
    ,TX_DATE
    ,PERIOD_ID
    ,FREQ
    ,YEAR
    ,FREQ_VALUE
    ,FREQ_DIFF
    ,CUSTOMER_ID
    ,TransTyp_ID
    ,CHANNEL
    ,TransBr_ID
    ,PROD_TYPE
    ,CUST_TRANS_AMT_LC
    ,CUST_TRANS_AMT_CWS_LC
    ,CUST_TRANS_AMT_SQT_LC
    ,CUST_TRANS_AMT_MAX_LC
    ,CUST_TRANS_AMT_MAX_DATE_LC
    ,CUST_TRANS_AMT_MIN_LC
    ,CUST_TRANS_AMT_MIN_DATE_LC
    ,CUST_TRANS_AMT_AVG_LC
    ,CUST_TRANS_AMT_AVG_CWS_LC
    ,CUST_TRANS_AMT_AVG_SQT_LC
    ,CUST_TRANS_CNT_LC
    ,CUST_TRANS_CNT_CWS_LC
    ,CUST_TRANS_CNT_SQT_LC
    ,CUST_TRANS_CNT_MAX_LC
    ,CUST_TRANS_CNT_MAX_DATE_LC
    ,CUST_TRANS_CNT_MIN_LC
    ,CUST_TRANS_CNT_MIN_DATE_LC
    ,CUST_TRANS_CNT_AVG_LC
    ,CUST_TRANS_CNT_AVG_CWS_LC
    ,CUST_TRANS_CNT_AVG_SQT_LC
    ,CUST_TRANS_AMT_FC
    ,CUST_TRANS_AMT_CWS_FC
    ,CUST_TRANS_AMT_SQT_FC
    ,CUST_TRANS_AMT_MAX_FC
    ,CUST_TRANS_AMT_MAX_DATE_FC
    ,CUST_TRANS_AMT_MIN_FC
    ,CUST_TRANS_AMT_MIN_DATE_FC
    ,CUST_TRANS_AMT_AVG_FC
    ,CUST_TRANS_AMT_AVG_CWS_FC
    ,CUST_TRANS_AMT_AVG_SQT_FC
    ,CUST_TRANS_CNT_FC
    ,CUST_TRANS_CNT_CWS_FC
    ,CUST_TRANS_CNT_SQT_FC
    ,CUST_TRANS_CNT_MAX_FC
    ,CUST_TRANS_CNT_MAX_DATE_FC
    ,CUST_TRANS_CNT_MIN_FC
    ,CUST_TRANS_CNT_MIN_DATE_FC
    ,CUST_TRANS_CNT_AVG_FC
    ,CUST_TRANS_CNT_AVG_CWS_FC
    ,CUST_TRANS_CNT_AVG_SQT_FC
    ,CUST_TRANS_AMT
    ,CUST_TRANS_AMT_CWS
    ,CUST_TRANS_AMT_SQT
    ,CUST_TRANS_AMT_MAX
    ,CUST_TRANS_AMT_MAX_DATE
    ,CUST_TRANS_AMT_MIN
    ,CUST_TRANS_AMT_MIN_DATE
    ,CUST_TRANS_AMT_AVG
    ,CUST_TRANS_AMT_AVG_CWS
    ,CUST_TRANS_AMT_AVG_SQT
    ,CUST_TRANS_CNT
    ,CUST_TRANS_CNT_CWS
    ,CUST_TRANS_CNT_SQT
    ,CUST_TRANS_CNT_MAX
    ,CUST_TRANS_CNT_MAX_DATE
    ,CUST_TRANS_CNT_MIN
    ,CUST_TRANS_CNT_MIN_DATE
    ,CUST_TRANS_CNT_AVG
    ,CUST_TRANS_CNT_AVG_CWS
    ,CUST_TRANS_CNT_AVG_SQT
    ,NEW_FLAG
    )

  SELECT
    ETL_DATE
    ,TX_DATE
    ,PERIOD_ID
    ,FREQ
    ,YEAR
    ,FREQ_VALUE
    ,FREQ_DIFF
    ,CUSTOMER_ID
    ,TransTyp_ID
    ,CHANNEL
    ,TransBr_ID
    ,PROD_TYPE
    ,CUST_TRANS_AMT_LC
    ,CUST_TRANS_AMT_CWS_LC
    ,CUST_TRANS_AMT_SQT_LC
    ,CUST_TRANS_AMT_MAX_LC
    ,CUST_TRANS_AMT_MAX_DATE_LC
    ,CUST_TRANS_AMT_MIN_LC
    ,CUST_TRANS_AMT_MIN_DATE_LC
    ,CUST_TRANS_AMT_AVG_LC
    ,CUST_TRANS_AMT_AVG_CWS_LC
    ,CUST_TRANS_AMT_AVG_SQT_LC
    ,CUST_TRANS_CNT_LC
    ,CUST_TRANS_CNT_CWS_LC
    ,CUST_TRANS_CNT_SQT_LC
    ,CUST_TRANS_CNT_MAX_LC
    ,CUST_TRANS_CNT_MAX_DATE_LC
    ,CUST_TRANS_CNT_MIN_LC
    ,CUST_TRANS_CNT_MIN_DATE_LC
    ,CUST_TRANS_CNT_AVG_LC
    ,CUST_TRANS_CNT_AVG_CWS_LC
    ,CUST_TRANS_CNT_AVG_SQT_LC
    ,CUST_TRANS_AMT_FC
    ,CUST_TRANS_AMT_CWS_FC
    ,CUST_TRANS_AMT_SQT_FC
    ,CUST_TRANS_AMT_MAX_FC
    ,CUST_TRANS_AMT_MAX_DATE_FC
    ,CUST_TRANS_AMT_MIN_FC
    ,CUST_TRANS_AMT_MIN_DATE_FC
    ,CUST_TRANS_AMT_AVG_FC
    ,CUST_TRANS_AMT_AVG_CWS_FC
    ,CUST_TRANS_AMT_AVG_SQT_FC
    ,CUST_TRANS_CNT_FC
    ,CUST_TRANS_CNT_CWS_FC
    ,CUST_TRANS_CNT_SQT_FC
    ,CUST_TRANS_CNT_MAX_FC
    ,CUST_TRANS_CNT_MAX_DATE_FC
    ,CUST_TRANS_CNT_MIN_FC
    ,CUST_TRANS_CNT_MIN_DATE_FC
    ,CUST_TRANS_CNT_AVG_FC
    ,CUST_TRANS_CNT_AVG_CWS_FC
    ,CUST_TRANS_CNT_AVG_SQT_FC
    ,CUST_TRANS_AMT
    ,CUST_TRANS_AMT_CWS
    ,CUST_TRANS_AMT_SQT
    ,CUST_TRANS_AMT_MAX
    ,CUST_TRANS_AMT_MAX_DATE
    ,CUST_TRANS_AMT_MIN
    ,CUST_TRANS_AMT_MIN_DATE
    ,CUST_TRANS_AMT_AVG
    ,CUST_TRANS_AMT_AVG_CWS
    ,CUST_TRANS_AMT_AVG_SQT
    ,CUST_TRANS_CNT
    ,CUST_TRANS_CNT_CWS
    ,CUST_TRANS_CNT_SQT
    ,CUST_TRANS_CNT_MAX
    ,CUST_TRANS_CNT_MAX_DATE
    ,CUST_TRANS_CNT_MIN
    ,CUST_TRANS_CNT_MIN_DATE
    ,CUST_TRANS_CNT_AVG
    ,CUST_TRANS_CNT_AVG_CWS
    ,CUST_TRANS_CNT_AVG_SQT
    ,NEW_FLAG
  FROM MMAPDM.DM_CUST_TRANS_STAT_PRE
  WHERE FREQ='''||FREQ||'''
    AND PERIOD_ID='||DM_YESTERDAY
    ;
    EXECUTE  IMMEDIATE DM_SQL;
    IO_ROW := IO_ROW+SQL%ROWCOUNT ;
    COMMIT;
    END IF;

    --备份"上日"数据
    --查询DM层表中是否有"上一日"数据，是否为重跑。    
    DM_SQL := ' SELECT COUNT(1) FROM MMAPDM.'||TABLE_NAME||' WHERE PERIOD_ID='||DM_YESTERDAY;
    EXECUTE  IMMEDIATE DM_SQL  INTO ST_ROW;
    IF ST_ROW>0
    THEN
      DM_SQL :='DELETE FROM MMAPDM.DM_CUST_TRANS_STAT_PRE WHERE FREQ='''||FREQ||'''' ;   -- 删除备份表中月频度数据
      EXECUTE IMMEDIATE DM_SQL;
      COMMIT;
      DM_SQL :='INSERT INTO MMAPDM.DM_CUST_TRANS_STAT_PRE SELECT * FROM MMAPDM.'||TABLE_NAME||' WHERE PERIOD_ID='||DM_YESTERDAY ;   -- 备份表中上日数据
      EXECUTE IMMEDIATE DM_SQL;
      IO_ROW :=IO_ROW+ SQL%ROWCOUNT ;
      COMMIT;
    END IF;

    --1.更新频度差
    DM_SQL :='UPDATE MMAPDM.'||TABLE_NAME||' SET FREQ_DIFF = FREQ_DIFF + 1
        WHERE (SELECT '||DAY_OF_FREQ||' FROM MMAPST.MID_CALENDAR WHERE PERIOD_ID='||DM_TODAY||')=1
      ';
    EXECUTE IMMEDIATE DM_SQL;
    IO_ROW := IO_ROW+SQL%ROWCOUNT ;
    COMMIT;
    --2. 建立临时表

    -----取前一天数据-----
    SELECT COUNT(1) INTO ST_ROW FROM USER_TABLES WHERE TABLE_NAME = 'TMP_CUST_TRANS_CAL';
    IF ST_ROW >0
    THEN
      DM_SQL := 'DROP TABLE MMAPDM.TMP_CUST_TRANS_CAL';
      EXECUTE IMMEDIATE DM_SQL;
    END IF;

  DM_SQL:= 'CREATE TABLE MMAPDM.TMP_CUST_TRANS_CAL AS
        SELECT
      '''||DM_TODAY||''' AS  ETL_DATE
      ,A.TX_DATE
      ,A.PERIOD_ID
      ,'''||FREQ||'''  AS FREQ
      ,A.YEAR
      ,B.'||FREQ_VALUE||' AS FREQ_VALUE
      ,0 AS FREQ_DIFF
      ,A.CUSTOMER_ID
      ,A.TransTyp_ID
      ,A.CHN_ID
      ,A.TransBr_ID
      ,A.PRODTYP_ID
      ,A.CUST_TRANS_AMT_LC
      --,C.CUST_TRANS_AMT_LC AS CUST_TRANS_AMT_CWS_LC
      ,0 AS CUST_TRANS_AMT_CWS_LC
      ,D.CUST_TRANS_AMT_LC AS CUST_TRANS_AMT_SQT_LC
      ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_AMT_LC
            ELSE GREATEST(NVL(A.CUST_TRANS_AMT_LC,0),NVL(E.CUST_TRANS_AMT_MAX_LC,0))
           END AS CUST_TRANS_AMT_MAX_LC
      ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
            ELSE (CASE WHEN NVL(A.CUST_TRANS_AMT_LC,0) - NVL(E.CUST_TRANS_AMT_MAX_LC,0) > 0
              THEN a.PERIOD_ID ELSE e.CUST_TRANS_AMT_MAX_LC
                  END)
           END AS CUST_TRANS_AMT_MAX_DATE_LC
      ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_AMT_LC
            ELSE LEAST(NVL(A.CUST_TRANS_AMT_LC,0),NVL(E.CUST_TRANS_AMT_MIN_LC,0))
           END AS CUST_TRANS_AMT_MIN_LC
      ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
            ELSE (CASE WHEN NVL(A.CUST_TRANS_AMT_LC,0) - NVL(E.CUST_TRANS_AMT_MIN_LC,0) < 0 THEN a.PERIOD_ID ELSE e.CUST_TRANS_AMT_MIN_DATE_LC END)
           END AS CUST_TRANS_AMT_MIN_DATE_LC
      ,CASE WHEN E.CUSTOMER_ID IS NULL THEN A.CUST_TRANS_AMT_LC
            ELSE ((NVL(E.CUST_TRANS_AMT_AVG_LC,0) * (B.'||DAY_OF_FREQ||'-1) + NVL(a.CUST_TRANS_AMT_LC,0)) / B.'||DAY_OF_FREQ||')
           END AS CUST_TRANS_AMT_AVG_LC
      --,C.CUST_TRANS_AMT_LC AS CUST_TRANS_AMT_AVG_CWS_LC
      ,0 AS CUST_TRANS_AMT_AVG_CWS_LC
      ,D.CUST_TRANS_AMT_LC AS CUST_TRANS_AMT_AVG_SQT_LC
      ,A.CUST_TRANS_CNT_LC
        --,C.CUST_TRANS_CNT_LC AS CUST_TRANS_CNT_CWS_LC
        ,0 AS CUST_TRANS_CNT_CWS_LC
        ,D.CUST_TRANS_CNT_LC AS CUST_TRANS_CNT_SQT_LC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_CNT_LC
              ELSE GREATEST(NVL(A.CUST_TRANS_CNT_LC,0),NVL(E.CUST_TRANS_CNT_MAX_LC,0))
             END AS CUST_TRANS_CNT_MAX_LC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_CNT_LC,0) - NVL(E.CUST_TRANS_CNT_MAX_LC,0) > 0
                THEN a.PERIOD_ID ELSE e.CUST_TRANS_CNT_MAX_LC
                    END)
             END AS CUST_TRANS_CNT_MAX_DATE_LC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_CNT_LC
              ELSE LEAST(NVL(A.CUST_TRANS_CNT_LC,0),NVL(E.CUST_TRANS_CNT_MIN_LC,0))
             END AS CUST_TRANS_CNT_MIN_LC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_CNT_LC,0) - NVL(E.CUST_TRANS_CNT_MIN_LC,0) < 0 THEN a.PERIOD_ID ELSE e.CUST_TRANS_CNT_MIN_DATE_LC END)
             END AS CUST_TRANS_CNT_MIN_DATE_LC
        ,CASE WHEN E.CUSTOMER_ID IS NULL THEN A.CUST_TRANS_CNT_LC
              ELSE ((NVL(E.CUST_TRANS_CNT_AVG_LC,0) * (B.'||DAY_OF_FREQ||'-1) + NVL(a.CUST_TRANS_CNT_LC,0)) / B.'||DAY_OF_FREQ||')
             END AS CUST_TRANS_CNT_AVG_LC
        --,C.CUST_TRANS_CNT_LC AS CUST_TRANS_CNT_AVG_CWS_LC
        ,0 AS CUST_TRANS_CNT_AVG_CWS_LC
        ,D.CUST_TRANS_CNT_LC AS CUST_TRANS_CNT_AVG_SQT_LC
      ,A.CUST_TRANS_AMT_FC
        --,C.CUST_TRANS_AMT_FC AS CUST_TRANS_AMT_CWS_FC
        ,0 AS CUST_TRANS_AMT_CWS_FC
        ,D.CUST_TRANS_AMT_FC AS CUST_TRANS_AMT_SQT_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_AMT_FC
              ELSE GREATEST(NVL(A.CUST_TRANS_AMT_FC,0),NVL(E.CUST_TRANS_AMT_MAX_FC,0))
             END AS CUST_TRANS_AMT_MAX_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_AMT_FC,0) - NVL(E.CUST_TRANS_AMT_MAX_FC,0) > 0
                THEN a.PERIOD_ID ELSE e.CUST_TRANS_AMT_MAX_FC
                    END)
             END AS CUST_TRANS_AMT_MAX_DATE_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_AMT_FC
              ELSE LEAST(NVL(A.CUST_TRANS_AMT_FC,0),NVL(E.CUST_TRANS_AMT_MIN_FC,0))
             END AS CUST_TRANS_AMT_MIN_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_AMT_FC,0) - NVL(E.CUST_TRANS_AMT_MIN_FC,0) < 0 THEN a.PERIOD_ID ELSE e.CUST_TRANS_AMT_MIN_DATE_FC END)
             END AS CUST_TRANS_AMT_MIN_DATE_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL THEN A.CUST_TRANS_AMT_FC
              ELSE ((NVL(E.CUST_TRANS_AMT_AVG_FC,0) * (B.'||DAY_OF_FREQ||'-1) + NVL(a.CUST_TRANS_AMT_FC,0)) / B.'||DAY_OF_FREQ||')
             END AS CUST_TRANS_AMT_AVG_FC
        --,C.CUST_TRANS_AMT_FC AS CUST_TRANS_AMT_AVG_CWS_FC
        ,0 AS CUST_TRANS_AMT_AVG_CWS_FC
        ,D.CUST_TRANS_AMT_FC AS CUST_TRANS_AMT_AVG_SQT_FC
      ,A.CUST_TRANS_CNT_FC
        --,C.CUST_TRANS_CNT_FC AS CUST_TRANS_CNT_CWS_FC
        ,0 AS CUST_TRANS_CNT_CWS_FC
        ,D.CUST_TRANS_CNT_FC AS CUST_TRANS_CNT_SQT_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_CNT_FC
              ELSE GREATEST(NVL(A.CUST_TRANS_CNT_FC,0),NVL(E.CUST_TRANS_CNT_MAX_FC,0))
             END AS CUST_TRANS_CNT_MAX_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_CNT_FC,0) - NVL(E.CUST_TRANS_CNT_MAX_FC,0) > 0
                THEN a.PERIOD_ID ELSE e.CUST_TRANS_CNT_MAX_FC
                    END)
             END AS CUST_TRANS_CNT_MAX_DATE_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_CNT_FC
              ELSE LEAST(NVL(A.CUST_TRANS_CNT_FC,0),NVL(E.CUST_TRANS_CNT_MIN_FC,0))
             END AS CUST_TRANS_CNT_MIN_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_CNT_FC,0) - NVL(E.CUST_TRANS_CNT_MIN_FC,0) < 0 THEN a.PERIOD_ID ELSE e.CUST_TRANS_CNT_MIN_DATE_FC END)
             END AS CUST_TRANS_CNT_MIN_DATE_FC
        ,CASE WHEN E.CUSTOMER_ID IS NULL THEN A.CUST_TRANS_CNT_FC
              ELSE ((NVL(E.CUST_TRANS_CNT_AVG_FC,0) * (B.'||DAY_OF_FREQ||'-1) + NVL(a.CUST_TRANS_CNT_FC,0)) / B.'||DAY_OF_FREQ||')
             END AS CUST_TRANS_CNT_AVG_FC
        --,C.CUST_TRANS_CNT_FC AS CUST_TRANS_CNT_AVG_CWS_FC
        ,0 AS CUST_TRANS_CNT_AVG_CWS_FC
        ,D.CUST_TRANS_CNT_FC AS CUST_TRANS_CNT_AVG_SQT_FC
      ,A.CUST_TRANS_AMT
        --,C.CUST_TRANS_AMT AS CUST_TRANS_AMT_CWS
        ,0 AS CUST_TRANS_AMT_CWS
        ,D.CUST_TRANS_AMT AS CUST_TRANS_AMT_SQT
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_AMT
              ELSE GREATEST(NVL(A.CUST_TRANS_AMT,0),NVL(E.CUST_TRANS_AMT_MAX,0))
             END AS CUST_TRANS_AMT_MAX
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_AMT,0) - NVL(E.CUST_TRANS_AMT_MAX,0) > 0
                THEN a.PERIOD_ID ELSE e.CUST_TRANS_AMT_MAX
                    END)
             END AS CUST_TRANS_AMT_MAX_DATE
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_AMT
              ELSE LEAST(NVL(A.CUST_TRANS_AMT,0),NVL(E.CUST_TRANS_AMT_MIN,0))
             END AS CUST_TRANS_AMT_MIN
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_AMT,0) - NVL(E.CUST_TRANS_AMT_MIN,0) < 0 THEN a.PERIOD_ID ELSE e.CUST_TRANS_AMT_MIN_DATE END)
             END AS CUST_TRANS_AMT_MIN_DATE
        ,CASE WHEN E.CUSTOMER_ID IS NULL THEN A.CUST_TRANS_AMT
              ELSE ((NVL(E.CUST_TRANS_AMT_AVG,0) * (B.'||DAY_OF_FREQ||'-1) + NVL(a.CUST_TRANS_AMT,0)) / B.'||DAY_OF_FREQ||')
             END AS CUST_TRANS_AMT_AVG
        --,C.CUST_TRANS_AMT AS CUST_TRANS_AMT_AVG_CWS
        ,0 AS CUST_TRANS_AMT_AVG_CWS
        ,D.CUST_TRANS_AMT AS CUST_TRANS_AMT_AVG_SQT
      ,A.CUST_TRANS_CNT
        --,C.CUST_TRANS_CNT AS CUST_TRANS_CNT_CWS
        ,0 AS CUST_TRANS_CNT_CWS
        ,D.CUST_TRANS_CNT AS CUST_TRANS_CNT_SQT
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_CNT
              ELSE GREATEST(NVL(A.CUST_TRANS_CNT,0),NVL(E.CUST_TRANS_CNT_MAX,0))
             END AS CUST_TRANS_CNT_MAX
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_CNT,0) - NVL(E.CUST_TRANS_CNT_MAX,0) > 0
                THEN a.PERIOD_ID ELSE e.CUST_TRANS_CNT_MAX
                    END)
             END AS CUST_TRANS_CNT_MAX_DATE
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.CUST_TRANS_CNT
              ELSE LEAST(NVL(A.CUST_TRANS_CNT,0),NVL(E.CUST_TRANS_CNT_MIN,0))
             END AS CUST_TRANS_CNT_MIN
        ,CASE WHEN E.CUSTOMER_ID IS NULL  THEN A.PERIOD_ID
              ELSE (CASE WHEN NVL(A.CUST_TRANS_CNT,0) - NVL(E.CUST_TRANS_CNT_MIN,0) < 0 THEN a.PERIOD_ID ELSE e.CUST_TRANS_CNT_MIN_DATE END)
             END AS CUST_TRANS_CNT_MIN_DATE
        ,CASE WHEN E.CUSTOMER_ID IS NULL THEN A.CUST_TRANS_CNT
              ELSE ((NVL(E.CUST_TRANS_CNT_AVG,0) * (B.'||DAY_OF_FREQ||'-1) + NVL(a.CUST_TRANS_CNT,0)) / B.'||DAY_OF_FREQ||')
             END AS CUST_TRANS_CNT_AVG
        --,C.CUST_TRANS_CNT AS CUST_TRANS_CNT_AVG_CWS
        ,0 AS CUST_TRANS_CNT_AVG_CWS
        ,D.CUST_TRANS_CNT AS CUST_TRANS_CNT_AVG_SQT
      ,0 AS NEW_FLAG

    FROM MMAPDM.TMP_CUST_TRANS_STAT A 
    LEFT JOIN MMAPST.MID_CALENDAR B
      ON A.PERIOD_ID = B.PERIOD_ID
        /*
        --同期c，暂不计算同期数据
        FULL JOIN  MMAPDM.'||TABLE_NAME||' C
        ON B.YEAR - 1 = C.YEAR
        AND B.'||FREQ_VALUE||' = C.FREQ_VALUE
        AND A.CUSTOMER_ID = C.CUSTOMER_ID
        AND C.PROD_TYPE = A.PROD_TYPE
        */
      --上期d，取上一统计期数据
  
      FULL JOIN MMAPDM.'||TABLE_NAME||' D
      ON D.FREQ_DIFF = 1
      AND A.CUSTOMER_ID = D.CUSTOMER_ID
      AND D.PROD_TYPE = A.PRODTYP_ID
      --最值e，取本统计期内数据
      FULL JOIN MMAPDM.'||TABLE_NAME||' E
      ON B.YEAR = E.YEAR
      AND B.'||FREQ_VALUE||' = E.FREQ_VALUE
      AND A.CUSTOMER_ID = E.CUSTOMER_ID
      AND E.PROD_TYPE = A.PRODTYP_ID
      ';

  EXECUTE IMMEDIATE DM_SQL;
    COMMIT;

 --删除本统计周期旧数据，及超期历史数据
    DM_SQL:= 'DELETE FROM MMAPDM.'||TABLE_NAME||' WHERE FREQ_DIFF =0 OR FREQ_DIFF>='||FREQ_HIS;
    EXECUTE IMMEDIATE DM_SQL;
    IO_ROW := IO_ROW+SQL%ROWCOUNT ;
    COMMIT;
    --插入当天数据
     DM_SQL:= 'INSERT INTO MMAPDM.'||TABLE_NAME||'
    (  ETL_DATE
    ,TX_DATE
    ,PERIOD_ID
    ,FREQ
    ,YEAR
    ,FREQ_VALUE
    ,FREQ_DIFF
    ,CUSTOMER_ID
    ,TransTyp_ID
    ,CHANNEL
    ,TransBr_ID
    ,PROD_TYPE
    ,CUST_TRANS_AMT_LC
    ,CUST_TRANS_AMT_CWS_LC
    ,CUST_TRANS_AMT_SQT_LC
    ,CUST_TRANS_AMT_MAX_LC
    ,CUST_TRANS_AMT_MAX_DATE_LC
    ,CUST_TRANS_AMT_MIN_LC
    ,CUST_TRANS_AMT_MIN_DATE_LC
    ,CUST_TRANS_AMT_AVG_LC
    ,CUST_TRANS_AMT_AVG_CWS_LC
    ,CUST_TRANS_AMT_AVG_SQT_LC
    ,CUST_TRANS_CNT_LC
    ,CUST_TRANS_CNT_CWS_LC
    ,CUST_TRANS_CNT_SQT_LC
    ,CUST_TRANS_CNT_MAX_LC
    ,CUST_TRANS_CNT_MAX_DATE_LC
    ,CUST_TRANS_CNT_MIN_LC
    ,CUST_TRANS_CNT_MIN_DATE_LC
    ,CUST_TRANS_CNT_AVG_LC
    ,CUST_TRANS_CNT_AVG_CWS_LC
    ,CUST_TRANS_CNT_AVG_SQT_LC
    ,CUST_TRANS_AMT_FC
    ,CUST_TRANS_AMT_CWS_FC
    ,CUST_TRANS_AMT_SQT_FC
    ,CUST_TRANS_AMT_MAX_FC
    ,CUST_TRANS_AMT_MAX_DATE_FC
    ,CUST_TRANS_AMT_MIN_FC
    ,CUST_TRANS_AMT_MIN_DATE_FC
    ,CUST_TRANS_AMT_AVG_FC
    ,CUST_TRANS_AMT_AVG_CWS_FC
    ,CUST_TRANS_AMT_AVG_SQT_FC
    ,CUST_TRANS_CNT_FC
    ,CUST_TRANS_CNT_CWS_FC
    ,CUST_TRANS_CNT_SQT_FC
    ,CUST_TRANS_CNT_MAX_FC
    ,CUST_TRANS_CNT_MAX_DATE_FC
    ,CUST_TRANS_CNT_MIN_FC
    ,CUST_TRANS_CNT_MIN_DATE_FC
    ,CUST_TRANS_CNT_AVG_FC
    ,CUST_TRANS_CNT_AVG_CWS_FC
    ,CUST_TRANS_CNT_AVG_SQT_FC
    ,CUST_TRANS_AMT
    ,CUST_TRANS_AMT_CWS
    ,CUST_TRANS_AMT_SQT
    ,CUST_TRANS_AMT_MAX
    ,CUST_TRANS_AMT_MAX_DATE
    ,CUST_TRANS_AMT_MIN
    ,CUST_TRANS_AMT_MIN_DATE
    ,CUST_TRANS_AMT_AVG
    ,CUST_TRANS_AMT_AVG_CWS
    ,CUST_TRANS_AMT_AVG_SQT
    ,CUST_TRANS_CNT
    ,CUST_TRANS_CNT_CWS
    ,CUST_TRANS_CNT_SQT
    ,CUST_TRANS_CNT_MAX
    ,CUST_TRANS_CNT_MAX_DATE
    ,CUST_TRANS_CNT_MIN
    ,CUST_TRANS_CNT_MIN_DATE
    ,CUST_TRANS_CNT_AVG
    ,CUST_TRANS_CNT_AVG_CWS
    ,CUST_TRANS_CNT_AVG_SQT
    ,NEW_FLAG
    )
  SELECT 
    ETL_DATE
    ,TX_DATE
    ,PERIOD_ID
    ,FREQ
    ,YEAR
    ,FREQ_VALUE
    ,0 AS FREQ_DIFF
    ,CUSTOMER_ID
    ,TransTyp_ID
    ,CHN_ID
    ,TransBr_ID
    ,PRODTYP_ID
    ,CUST_TRANS_AMT_LC
    ,CUST_TRANS_AMT_CWS_LC
    ,CUST_TRANS_AMT_SQT_LC
    ,CUST_TRANS_AMT_MAX_LC
    ,CUST_TRANS_AMT_MAX_DATE_LC
    ,CUST_TRANS_AMT_MIN_LC
    ,CUST_TRANS_AMT_MIN_DATE_LC
    ,CUST_TRANS_AMT_AVG_LC
    ,CUST_TRANS_AMT_AVG_CWS_LC
    ,CUST_TRANS_AMT_AVG_SQT_LC
    ,CUST_TRANS_CNT_LC
    ,CUST_TRANS_CNT_CWS_LC
    ,CUST_TRANS_CNT_SQT_LC
    ,CUST_TRANS_CNT_MAX_LC
    ,CUST_TRANS_CNT_MAX_DATE_LC
    ,CUST_TRANS_CNT_MIN_LC
    ,CUST_TRANS_CNT_MIN_DATE_LC
    ,CUST_TRANS_CNT_AVG_LC
    ,CUST_TRANS_CNT_AVG_CWS_LC
    ,CUST_TRANS_CNT_AVG_SQT_LC
    ,CUST_TRANS_AMT_FC
    ,CUST_TRANS_AMT_CWS_FC
    ,CUST_TRANS_AMT_SQT_FC
    ,CUST_TRANS_AMT_MAX_FC
    ,CUST_TRANS_AMT_MAX_DATE_FC
    ,CUST_TRANS_AMT_MIN_FC
    ,CUST_TRANS_AMT_MIN_DATE_FC
    ,CUST_TRANS_AMT_AVG_FC
    ,CUST_TRANS_AMT_AVG_CWS_FC
    ,CUST_TRANS_AMT_AVG_SQT_FC
    ,CUST_TRANS_CNT_FC
    ,CUST_TRANS_CNT_CWS_FC
    ,CUST_TRANS_CNT_SQT_FC
    ,CUST_TRANS_CNT_MAX_FC
    ,CUST_TRANS_CNT_MAX_DATE_FC
    ,CUST_TRANS_CNT_MIN_FC
    ,CUST_TRANS_CNT_MIN_DATE_FC
    ,CUST_TRANS_CNT_AVG_FC
    ,CUST_TRANS_CNT_AVG_CWS_FC
    ,CUST_TRANS_CNT_AVG_SQT_FC
    ,CUST_TRANS_AMT
    ,CUST_TRANS_AMT_CWS
    ,CUST_TRANS_AMT_SQT
    ,CUST_TRANS_AMT_MAX
    ,CUST_TRANS_AMT_MAX_DATE
    ,CUST_TRANS_AMT_MIN
    ,CUST_TRANS_AMT_MIN_DATE
    ,CUST_TRANS_AMT_AVG
    ,CUST_TRANS_AMT_AVG_CWS
    ,CUST_TRANS_AMT_AVG_SQT
    ,CUST_TRANS_CNT
    ,CUST_TRANS_CNT_CWS
    ,CUST_TRANS_CNT_SQT
    ,CUST_TRANS_CNT_MAX
    ,CUST_TRANS_CNT_MAX_DATE
    ,CUST_TRANS_CNT_MIN
    ,CUST_TRANS_CNT_MIN_DATE
    ,CUST_TRANS_CNT_AVG
    ,CUST_TRANS_CNT_AVG_CWS
    ,CUST_TRANS_CNT_AVG_SQT
    ,NEW_FLAG
    
  FROM MMAPDM.TMP_CUST_TRANS_CAL
  ';
  EXECUTE  IMMEDIATE DM_SQL;
    IO_ROW := IO_ROW+SQL%ROWCOUNT ;

    /*
        写入日志
    */

    SELECT SYSDATE INTO V_END_TIMESTAMP   FROM dual;    -- 加载程序运行结束时间
    IO_STATUS := 0 ;
    IO_SQLERR := 'SUSSCESS';
    P_MMAPDM_WRITE_LOGS(PROCEDURE_NAME,IO_STATUS,IO_ROW,V_START_TIMESTAMP,V_END_TIMESTAMP,IO_SQLERR);
    COMMIT;

    EXCEPTION
      WHEN OTHERS THEN
    ROLLBACK ;
    IO_STATUS := 9 ;
    P_DM_CUST_TRANS_STAT_ROLLBACK(TABLE_NAME,DM_TODAY,DM_YESTERDAY,FREQ);
    IO_SQLERR := SQLCODE ||  SQLERRM  ;
    SELECT SYSDATE INTO  V_END_TIMESTAMP  FROM dual;
    P_MMAPDM_WRITE_LOGS(PROCEDURE_NAME,IO_STATUS,IO_ROW,V_START_TIMESTAMP,V_END_TIMESTAMP,IO_SQLERR);
END P_DM_CUST_TRANS_STAT_FREQ;
