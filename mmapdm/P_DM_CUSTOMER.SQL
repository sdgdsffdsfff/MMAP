CREATE OR REPLACE PROCEDURE P_DM_CUSTOMER
(IO_STATUS OUT INTEGER,IO_SQLERR OUT VARCHAR2)
AS
	TABLE_NAME VARCHAR2(125) :='DM_CUSTOMER';  -- 表名(修改)
	PROCEDURE_NAME VARCHAR2(125) :='P_'||TABLE_NAME;  -- 存储过程名(修改)

	DM_SQL VARCHAR2(20000);  -- 存放SQL语句

	IO_ROW INTEGER;  --插入条数
	ST_ROW INTEGER;  --源数据条数

	V_ETL_DATE NUMBER;  -- 跑批日期
	V_START_TIMESTAMP TIMESTAMP;  -- 加载开始时间
	V_END_TIMESTAMP   TIMESTAMP;  -- 加载结束时间

	DM_TODAY NUMBER;        -- 数据日期"当日"
	DM_YESTERDAY NUMBER;	-- 数据日期"上一日"

	TX_DATE NUMBER;

BEGIN
	SELECT SYSDATE INTO V_START_TIMESTAMP FROM dual;  -- 加载程序运行开始时间

	SELECT TO_NUMBER(TO_CHAR((SYSDATE),'YYYYMMDD')) INTO V_ETL_DATE FROM dual;  -- 取系统日期作为跑批日期
	SELECT TX_DATE INTO DM_TODAY FROM MMAPST.ST_SYSTEM_DATE;  --取数据日期

	--查询ST层表中是否有'当日'数据
	SELECT COUNT(1) INTO ST_ROW FROM MMAPST.ST_CUSTOMER WHERE PERIOD_ID=DM_TODAY ;

	--如果ST层有"当日"数据，则进行数据抽取，否则保持DM层现有数据不变。
	IF ST_ROW>0
	THEN
		IO_ROW := 0;
		--备份"上日"数据
		SELECT PRE_DATE INTO DM_YESTERDAY FROM MMAPST.ST_SYSTEM_DATE;  -- 取数据日期"上一日"
		--查询DM层表中是否有"上一日"数据，是否为重跑。
		SELECT COUNT(1) INTO ST_ROW FROM MMAPDM.DM_CUSTOMER WHERE PERIOD_ID=DM_YESTERDAY;
		IF ST_ROW>0
		THEN
			DM_SQL :='TRUNCATE TABLE MMAPDM.DM_CUSTOMER_PRE' ;   -- 删除备份表中数据
			EXECUTE IMMEDIATE DM_SQL;
			COMMIT;
			DM_SQL :='INSERT INTO MMAPDM.DM_CUSTOMER_PRE SELECT * FROM MMAPDM.DM_CUSTOMER' ;   -- 备份表中数据
			EXECUTE IMMEDIATE DM_SQL;
			IO_ROW := SQL%ROWCOUNT ;
			COMMIT;
		END IF;

		--本调度逻辑为全删全插
		DM_SQL :='DELETE FROM MMAPDM.DM_CUSTOMER' ;   -- 删除表中数据
		EXECUTE IMMEDIATE DM_SQL;

		DM_SQL :='INSERT INTO MMAPDM.DM_CUSTOMER
			(
				ETL_DATE
				,TX_DATE
				,PERIOD_ID
				,CUSTOMER_ID
				,CUST_NAME
				,AGE
				,BIRTH_DT
				,GENDER_CODE
				,GENDER
				,EDU_CODE
				,EDUCATION
				,MARITALSTS_CODE
				,MARITALSTS
				,Family_GROUP_ID
				,CMP_DEP
				,OCUP_CODE
				,OCUP
				,OCCP_CODE
				,OCCP
				,POSITION_CODE
				,POSITION
				,POSITION_TITLE_CODE
				,POSITION_TITLE
				,INCOME
				,INCOME_RANGE
				,RESD_CODE
				,RESD
				,COUNTRY_CODE
				,COUNTRY
				,RACE_CODE
				,RACE
				,IDTYPE_CODE
				,IDTYPE
				,IDCODE
				,IDCOUNTRY_CODE
				,IDCOUNTRY
				,IDEXP_DT
				,IDISS_DT
				,CUST_BRANCH
				,OPEN_BRANCH
				,OWN_BRANCH
				,FIN_MANAGER
				,FIN_MANAGER_PHONE
				,CIFOPEN_DT
				,CIFCLOSE_DT
				,CIF_LVL_CODE
				,CIF_LVL
				,CIF_LVL_DATE
				,CARD_LVL_CODE
				,CARD_LVL
				,CARD_Date
				,RISK_LVL_CODE
				,RISK_LVL_TYP
				,RATING_LVL_CODE
				,RATING_LVL
				,LOAN_AMT
				,CONTRIBUTION_RATE
				,CUST_LTV
				,EMP_IND
				,BLACKLIST_IND
				,WHITELIST_IND
				,BREAK_IND
				,CUST_STATUS_IND
				,PRODUCT_HOLDING_NOW
				,PRODUCT_HOLDING_HIS
				,CUST_CD_BAL_LC
				,CUST_TD_BAL_LC
				,CUST_LOAN_BAL_LC
				,CUST_NDEBT_BAL_LC
				,CUST_FOUND_BAL_LC
				,CUST_FIN_BAL_LC
				,CUST_INSURE_BAL_LC
				,CUST_NOBLE_BAL_LC
				,CUST_CREDIT_BAL_LC
				,CUST_ALL_BAL_LC
				,CUST_CD_BAL_FC
				,CUST_TD_BAL_FC
				,CUST_LOAN_BAL_FC
				,CUST_CREDIT_BAL_FC
				,CUST_ALL_BAL_FC
				,CUST_ALL_BAL
			)
			SELECT
				'||V_ETL_DATE||' AS ETL_DATE
				,A.TX_DATE
				,TO_NUMBER(TO_CHAR(A.TX_DATE,''YYYYMMDD'')) AS PERIOD_ID
				,A.CUSTOMER_ID
				,CUST_NAME
				,AGE
				,BIRTH_DT
				,B.ITEM_ID
				,B.ITEM_NM AS GENDER
				,C.ITEM_ID
				,C.ITEM_NM AS EDUCATION
				,D.ITEM_ID
				,D.ITEM_NM AS MARITALSTS
				,NULL AS FAMILY_GROUP_ID
				,CMP_DEP
				,E.ITEM_ID
				,E.ITEM_NM AS OCUP
				,F.ITEM_ID
				,F.ITEM_NM AS OCCP
				,G.ITEM_ID
				,G.ITEM_NM AS POSITION
				,H.ITEM_ID
				,H.ITEM_NM AS POSITION_TITLE
				,INCOME
				,INCOME_RANGE
				,I.ITEM_ID
				,I.ITEM_NM AS  RESD
				,J.ITEM_ID
				,J.ITEM_NM AS COUNTRY
				,K.ITEM_ID
				,K.ITEM_NM AS RACE
				,L.ITEM_ID
				,L.ITEM_NM AS IDTYPE
				,IDCODE
				,M.ITEM_ID
				,M.ITEM_NM AS  IDCOUNTRY
				,IDEXP_DT
				,IDISS_DT
				,CUST_BRANCH
				,OPEN_BRANCH
				,OWN_BRANCH
				,FIN_MANAGER
				,FIN_MANAGER_PHONE
				,CIFOPEN_DT
				,CIFCLOSE_DT
				,P.CIF_LVL_CODE
				,P.CIF_LVL
				,P.CIF_LVL_DATE
				,P.CARD_LVL_CODE
				,P.CARD_LVL
				,P.CARD_DATE
				,N.ITEM_ID
				,N.ITEM_NM AS RISK_LVL_TYP
				,O.ITEM_ID
				,O.ITEM_NM AS RATING_LVL
				,LOAN_AMT
				,CONTRIBUTION_RATE
				,NULL AS CUST_LTV
				,EMP_IND
				,BLACKLIST_IND
				,WHITELIST_IND
				,NULL AS BREAK_IND
				,NULL AS CUST_STATUS_IND
				,NULL AS PRODUCT_HOLDING_NOW
				,NULL AS PRODUCT_HOLDING_HIS
				,Q.CUST_CD_BAL_LC
				,Q.CUST_TD_BAL_LC
				,Q.CUST_LOAN_BAL_LC
				,Q.CUST_NDEBT_BAL_LC
				,Q.CUST_FOUND_BAL_LC
				,Q.CUST_FIN_BAL_LC
				,Q.CUST_INSURE_BAL_LC
				,Q.CUST_NOBLE_BAL_LC
				,Q.CUST_CREDIT_BAL_LC
				,Q.CUST_ALL_BAL_LC
				,Q.CUST_CD_BAL_FC
				,Q.CUST_TD_BAL_FC
				,Q.CUST_LOAN_BAL_FC
				,Q.CUST_CREDIT_BAL_FC
				,Q.CUST_ALL_BAL_FC
				,Q.CUST_ALL_BAL
			FROM	MMAPST.ST_CUSTOMER A
			--关联码值
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''GENDER'')B
			ON	A.GENDER_CODE=B.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''EDU'')C
			ON	A.EDU_CODE=C.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''MARITALSTS'')D
			ON	A.MARITALSTS_CODE=D.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''OCUP'')E
			ON	A.OCUP_CODE=E.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''OCCP'')F
			ON	A.OCCP_CODE=F.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''POSITION'')G
			ON	A.POSITION_CODE=G.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''POSITION_TITLE'')H
			ON	A.POSITION_TITLE_CODE=H.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RESD'')I
			ON	A.RESD_CODE=I.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''COUNTRY'')J
			ON	A.COUNTRY_CODE=J.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RACE'')K
			ON	A.RACE_CODE=K.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''IDTYPE'')L
			ON	A.IDTYPE_CODE=L.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''IDCOUNTRY'')M
			ON	A.IDCOUNTRY_CODE=M.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RISK_LVL'')N
			ON	A.RISK_LVL_CODE=N.SOURCE_ITEM_ID
			LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RATING_LVL'')O
			ON	A.RATING_LVL_CODE=O.SOURCE_ITEM_ID
			--关联客户级别
			LEFT JOIN (SELECT * FROM MMAPDM.DM_CUST_CARD_LVL_HIS WHERE DM_END_DT=99991231) P
			ON	A.CUSTOMER_ID=P.CUSTOMER_ID
			--关联客户余额
			LEFT JOIN (SELECT * FROM MMAPDM.DM_CUST_BAL_HIS WHERE DM_END_DT=99991231) Q
			ON	A.CUSTOMER_ID=Q.CUSTOMER_ID
			';
		EXECUTE IMMEDIATE DM_SQL;
		IO_ROW := IO_ROW+SQL%ROWCOUNT ;
	END IF;

	/*写入日志信息*/

	IO_STATUS := 0 ;
	IO_SQLERR := 'SUSSCESS';
	SELECT SYSDATE INTO V_END_TIMESTAMP FROM DUAL;  -- 加载程序运行结束时间
	P_MMAPDM_WRITE_LOGS(PROCEDURE_NAME,IO_STATUS,IO_ROW,V_START_TIMESTAMP,V_END_TIMESTAMP,IO_SQLERR);
	COMMIT;

	EXCEPTION
	  WHEN OTHERS  THEN
	ROLLBACK;
	IO_STATUS := 9;
	IO_SQLERR := SQLCODE ||  SQLERRM;
	SELECT SYSDATE INTO V_END_TIMESTAMP FROM DUAL;
	P_MMAPDM_WRITE_LOGS(PROCEDURE_NAME,IO_STATUS,IO_ROW,V_START_TIMESTAMP,V_END_TIMESTAMP,IO_SQLERR);
END P_DM_CUSTOMER;
/
