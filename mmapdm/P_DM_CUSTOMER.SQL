CREATE OR REPLACE PROCEDURE P_DM_CUSTOMER
(IO_STATUS OUT INTEGER,IO_SQLERR OUT VARCHAR2)
AS

  TABLE_NAME VARCHAR2(125) :='CUSTOMER';  -- 表名(修改)
BEGIN
/*
--编辑取数SQL
DELETE MMAPDM.MMAPDM_PROC_SQL WHERE TABLE_NAME='DM_CUSTOMER';
COMMIT;
DECLARE  
  DMSQL CLOB := '
      SELECT
        TO_NUMBER(TO_CHAR((SYSDATE),''YYYYMMDD''))
        ,A.TX_DATE
        ,TO_NUMBER(TO_CHAR(A.TX_DATE,''YYYYMMDD'')) AS PERIOD_ID
        ,A.CUSTOMER_ID
        ,CUST_NAME
        ,AGE
        ,BIRTH_DT
        ,B.ITEM_ID
        ,B.ITEM_NM AS GENDER
        ,C.ITEM_ID
        ,C.ITEM_NM AS EDUCATION
        ,D.ITEM_ID
        ,D.ITEM_NM AS MARITALSTS
        ,NULL AS FAMILY_GROUP_ID
        ,CMP_DEP
        ,E.ITEM_ID
        ,E.ITEM_NM AS OCUP
        ,F.ITEM_ID
        ,F.ITEM_NM AS OCCP
        ,G.ITEM_ID
        ,G.ITEM_NM AS POSITION
        ,H.ITEM_ID
        ,H.ITEM_NM AS POSITION_TITLE
        ,INCOME
        ,INCOME_RANGE
        ,I.ITEM_ID
        ,I.ITEM_NM AS  RESD
        ,J.ITEM_ID
        ,J.ITEM_NM AS COUNTRY
        ,K.ITEM_ID
        ,K.ITEM_NM AS RACE
        ,L.ITEM_ID
        ,L.ITEM_NM AS IDTYPE
        ,IDCODE
        ,M.ITEM_ID
        ,M.ITEM_NM AS  IDCOUNTRY
        ,IDEXP_DT
        ,IDISS_DT
        ,CUST_BRANCH
        ,OPEN_BRANCH
        ,OWN_BRANCH
        ,FIN_MANAGER
        ,FIN_MANAGER_PHONE
        ,CIFOPEN_DT
        ,CIFCLOSE_DT
        ,P.CIF_LVL_CODE
        ,P.CIF_LVL
        ,P.CIF_LVL_DATE
        ,P.CARD_LVL_CODE
        ,P.CARD_LVL
        ,P.CARD_DATE
        ,N.ITEM_ID
        ,N.ITEM_NM AS RISK_LVL_TYP
        ,O.ITEM_ID
        ,O.ITEM_NM AS RATING_LVL
        ,LOAN_AMT
        ,CONTRIBUTION_RATE
        ,NULL AS CUST_LTV
        ,EMP_IND
        ,BLACKLIST_IND
        ,WHITELIST_IND
        ,NULL AS BREAK_IND
        ,NULL AS CUST_STATUS_IND
        ,NULL AS PRODUCT_HOLDING_NOW
        ,NULL AS PRODUCT_HOLDING_HIS
        ,Q.CUST_CD_BAL_LC
        ,Q.CUST_TD_BAL_LC
        ,Q.CUST_LOAN_BAL_LC
        ,Q.CUST_NDEBT_BAL_LC
        ,Q.CUST_FOUND_BAL_LC
        ,Q.CUST_FIN_BAL_LC
        ,Q.CUST_INSURE_BAL_LC
        ,Q.CUST_NOBLE_BAL_LC
        ,Q.CUST_CREDIT_BAL_LC
        ,Q.CUST_ALL_BAL_LC
        ,Q.CUST_CD_BAL_FC
        ,Q.CUST_TD_BAL_FC
        ,Q.CUST_LOAN_BAL_FC
        ,Q.CUST_CREDIT_BAL_FC
        ,Q.CUST_ALL_BAL_FC
        ,Q.CUST_ALL_BAL
      FROM  MMAPST.ST_CUSTOMER A
      --关联码值
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''GENDER'')B
      ON  A.GENDER_CODE=B.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''EDU'')C
      ON  A.EDU_CODE=C.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''MARITALSTS'')D
      ON  A.MARITALSTS_CODE=D.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''OCUP'')E
      ON  A.OCUP_CODE=E.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''OCCP'')F
      ON  A.OCCP_CODE=F.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''POSITION'')G
      ON  A.POSITION_CODE=G.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''POSITION_TITLE'')H
      ON  A.POSITION_TITLE_CODE=H.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RESD'')I
      ON  A.RESD_CODE=I.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''COUNTRY'')J
      ON  A.COUNTRY_CODE=J.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RACE'')K
      ON  A.RACE_CODE=K.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''IDTYPE'')L
      ON  A.IDTYPE_CODE=L.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''IDCOUNTRY'')M
      ON  A.IDCOUNTRY_CODE=M.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RISK_LVL'')N
      ON  A.RISK_LVL_CODE=N.SOURCE_ITEM_ID
      LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RATING_LVL'')O
      ON  A.RATING_LVL_CODE=O.SOURCE_ITEM_ID
      --关联客户级别
      LEFT JOIN (SELECT * FROM MMAPDM.DM_CUST_CARD_LVL_HIS WHERE DM_END_DT=99991231) P
      ON  A.CUSTOMER_ID=P.CUSTOMER_ID
      --关联客户余额
      LEFT JOIN (SELECT * FROM MMAPDM.DM_CUST_BAL_HIS WHERE DM_END_DT=99991231) Q
      ON  A.CUSTOMER_ID=Q.CUSTOMER_ID';  
BEGIN 
  
INSERT INTO MMAPDM.MMAPDM_PROC_SQL(TABLE_NAME,DMSQL,PROC_NAME) VALUES('DM_CUSTOMER',DMSQL,'P_DM_CUSTOMER');  

END;
/
COMMIT;
*/

    P_DM_FULL(TABLE_NAME,500000,IO_STATUS,IO_SQLERR);
END P_DM_CUSTOMER;
/
