CREATE OR REPLACE PROCEDURE "P_DM_CUSTOMER"
(IO_STATUS OUT INTEGER,IO_SQLERR OUT VARCHAR2)
AS

	TABLE_NAME VARCHAR2(125) :='DM_CUSTOMER';  -- 表名(修改)
  PROCEDURE_NAME VARCHAR2(125) :='P_'||TABLE_NAME;  -- 存储过程名(修改)

  IO_ROW INTEGER;  --插入条数
  ST_ROW INTEGER;  --源数据条数

  V_ETL_DATE NUMBER;  -- 跑批日期
  V_START_TIMESTAMP TIMESTAMP;  -- 加载开始时间
  V_END_TIMESTAMP TIMESTAMP;  -- 加载结束时间
  
  DM_TODAY NUMBER;        -- 数据日期"当日"
	TX_DATE NUMBER;

  DM_SQL VARCHAR2(20000);  -- 存放SQL语句

BEGIN

  SELECT SYSDATE INTO V_START_TIMESTAMP  FROM dual;  -- 加载程序运行开始时间

  SELECT TO_NUMBER(TO_CHAR((SYSDATE),'YYYYMMDD')) INTO V_ETL_DATE FROM dual;  -- 取系统日期作为跑批日期
  
  SELECT TX_DATE INTO DM_TODAY FROM MMAPST.ST_SYSTEM_DATE;  --取数据日期

  --查询ST层表中是否有'当日'数据
  SELECT COUNT(1) INTO ST_ROW FROM MMAPST.ST_CUSTOMER 
  WHERE PERIOD_ID=DM_TODAY ;
  IF ST_ROW>0
  THEN
    --本调度逻辑为全删全插
    DM_SQL :='TRUNCATE TABLE MMAPDM.DM_CUSTOMER' ;   -- 删除表中数据
    EXECUTE IMMEDIATE DM_SQL;
    COMMIT;

    DM_SQL :='
      INSERT INTO MMAPDM.DM_CUSTOMER
      (
        ETL_DATE 
       ,TX_DATE
       ,PERIOD_ID
       ,CUSTOMER_ID
       ,CUST_NAME
       ,AGE
       ,BIRTH_DT
       ,GENDER_CODE  
       ,GENDER
       ,EDU_CODE
       ,EDUCATION
       ,MARITALSTS_CODE
       ,MARITALSTS
       ,Family_GROUP_ID
       ,CMP_DEP
       ,OCUP_CODE
       ,OCUP
       ,OCCP_CODE
       ,OCCP
       ,POSITION_CODE
       ,POSITION
       ,POSITION_TITLE_CODE 
       ,POSITION_TITLE
       ,INCOME
       ,INCOME_RANGE
       ,RESD_CODE
       ,RESD
       ,COUNTRY_CODE 
       ,COUNTRY
       ,RACE_CODE 
       ,RACE
       ,IDTYPE_CODE
       ,IDTYPE
       ,IDCODE
       ,IDCOUNTRY_CODE 
       ,IDCOUNTRY
       ,IDEXP_DT
       ,IDISS_DT
       ,CUST_BRANCH
       ,OPEN_BRANCH
       ,OWN_BRANCH
       ,FIN_MANAGER
       ,FIN_MANAGER_PHONE
       ,CIFOPEN_DT
       ,CIFCLOSE_DT
       ,CIF_LVL_CODE 
       ,CIF_LVL
       ,CIF_LVL_DATE
       ,CARD_LVL_CODE
       ,CARD_LVL
       ,CARD_Date
       ,RISK_LVL_CODE 
       ,RISK_LVL_TYP
       ,RATING_LVL_CODE 
       ,RATING_LVL
       ,LOAN_AMT
       ,CONTRIBUTION_RATE
       ,CUST_LTV
       ,EMP_IND
       ,BLACKLIST_IND
       ,WHITELIST_IND
       ,BREAK_IND
       ,CUST_STATUS_IND
       ,PRODUCT_HOLDING_NOW                
       ,PRODUCT_HOLDING_HIS
       ,CUST_LC_CD_BAL
       ,CUST_LC_TD_BAL
       ,CUST_LC_LOAN_BAL
       ,CUST_LC_NDEBT_BAL
       ,CUST_LC_FOUND_BAL
       ,CUST_LC_FIN_BAL
       ,CUST_LC_INSURE_BAL
       ,CUST_LC_NOBLE_BAL
       ,CUST_LC_CREDIT_BAL
       ,CUST_LC_ALL_BAL
       ,CUST_FC_CD_BAL
       ,CUST_FC_TD_BAL
       ,CUST_FC_LOAN_BAL
       ,CUST_FC_CREDIT_BAL
       ,CUST_FC_ALL_BAL
       ,CUST_ALL_BAL
     )
      SELECT
        '||V_ETL_DATE||' AS ETL_DATE
       ,TX_DATE
       ,TO_NUMBER(TO_CHAR(SYSDATE,''YYYYMMDD'')) AS PERIOD_ID                 
       ,CUSTOMER_ID             
       ,CUST_NAME               
       ,AGE                     
       ,BIRTH_DT 
       ,GENDER_CODE               
       ,B.ITEM_NM AS GENDER
       ,EDU_CODE          
       ,C.ITEM_NM AS EDUCATION 
       ,MARITALSTS_CODE      
       ,D.ITEM_NM AS MARITALSTS      
       ,NULL AS FAMILY_GROUP_ID 
       ,CMP_DEP 
       ,OCUP_CODE                
       ,E.ITEM_NM AS OCUP  
       ,OCCP_CODE          
       ,F.ITEM_NM AS OCCP  
       ,POSITION_CODE          
       ,G.ITEM_NM AS POSITION  
       ,POSITION_TITLE_CODE      
       ,H.ITEM_NM AS POSITION_TITLE  
       ,INCOME                  
       ,INCOME_RANGE 
       ,RESD_CODE           
       ,I.ITEM_NM AS  RESD 
       ,COUNTRY_CODE          
       ,J.ITEM_NM AS COUNTRY
       ,RACE_CODE         
       ,K.ITEM_NM AS RACE            
       ,IDTYPE_CODE
       ,L.ITEM_NM AS IDTYPE            
       ,IDCODE                  
       ,IDCOUNTRY_CODE
       ,M.ITEM_ID AS  IDCOUNTRY       
       ,IDEXP_DT                
       ,IDISS_DT                
       ,CUST_BRANCH             
       ,OPEN_BRANCH             
       ,OWN_BRANCH              
       ,FIN_MANAGER             
       ,FIN_MANAGER_PHONE       
       ,CIFOPEN_DT              
       ,CIFCLOSE_DT 
       ,CIF_LVL_CODE            
       ,N.ITEM_NM AS CIF_LVL         
       ,NULL AS CIF_LVL_DATE 
       ,NULL AS CARD_LVL_CODE 
       ,NULL AS CARD_LVL       
       ,NULL AS CARD_DATE
       ,RISK_LVL_CODE      
       ,O.ITEM_NM AS RISK_LVL_TYP  
       ,RATING_LVL_CODE  
       ,P.ITEM_NM AS RATING_LVL      
       ,LOAN_AMT                
       ,CONTRIBUTION_RATE       
       ,NULL AS CUST_LTV        
       ,EMP_IND                 
       ,BLACKLIST_IND           
       ,WHITELIST_IND           
       ,NULL AS BREAK_IND       
       ,NULL AS CUST_STATUS_IND 
       ,NULL AS PRODUCT_HOLDING_NOW                
       ,NULL AS PRODUCT_HOLDING_HIS
       ,NULL AS CUST_LC_CD_BAL
       ,NULL AS CUST_LC_TD_BAL
       ,NULL AS CUST_LC_LOAN_BAL
       ,NULL AS CUST_LC_NDEBT_BAL
       ,NULL AS CUST_LC_FOUND_BAL
       ,NULL AS CUST_LC_FIN_BAL
       ,NULL AS CUST_LC_INSURE_BAL
       ,NULL AS CUST_LC_NOBLE_BAL
       ,NULL AS CUST_LC_CREDIT_BAL
       ,NULL AS CUST_LC_ALL_BAL
       ,NULL AS CUST_FC_CD_BAL
       ,NULL AS CUST_FC_TD_BAL
       ,NULL AS CUST_FC_LOAN_BAL
       ,NULL AS CUST_FC_CREDIT_BAL
       ,NULL AS CUST_FC_ALL_BAL
       ,NULL AS CUST_ALL_BAL
FROM MMAPST.ST_CUSTOMER A
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''GENDER'')B
ON A.GENDER_CODE=B.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''EDU'')C
ON A.EDU_CODE=C.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''MARITALSTS'')D
ON A.MARITALSTS_CODE=D.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''OCUP'')E
ON A.OCUP_CODE=E.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''OCCP'')F
ON A.OCCP_CODE=F.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''POSITION'')G
ON A.POSITION_CODE=G.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''POSITION_TITLE'')H
ON A.POSITION_TITLE_CODE=H.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RESD'')I
ON A.RESD_CODE=I.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''COUNTRY'')J
ON A.COUNTRY_CODE=J.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RACE'')K
ON A.RACE_CODE=K.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''IDTYPE'')L
ON A.IDTYPE_CODE=L.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''IDCOUNTRY'')M
ON A.IDCOUNTRY_CODE=M.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''CIF_LVL'')N
ON A.CIF_LVL_CODE=N.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RISK_LVL'')O
ON A.RISK_LVL_CODE=O.SOURCE_ITEM_ID
LEFT JOIN (SELECT SOURCE_ITEM_ID,SOURCE_ITEM_NM,ITEM_ID,ITEM_NM FROM MMAPST.ST_ITEM  WHERE ITEM_TYP=''RATING_LVL'')P
ON A.RATING_LVL_CODE=P.SOURCE_ITEM_ID';
    
    EXECUTE   IMMEDIATE DM_SQL;
    COMMIT;
    
    IO_ROW := SQL%ROWCOUNT ;  
    
  END IF;
  SELECT SYSDATE INTO V_END_TIMESTAMP FROM DUAL;  -- 加载程序运行结束时间

  IO_STATUS := 0 ;
  IO_SQLERR := 'SUSSCESS';
  P_MMAPDM_WRITE_LOGS(PROCEDURE_NAME,IO_STATUS,IO_ROW,V_START_TIMESTAMP,V_END_TIMESTAMP,IO_SQLERR);
  COMMIT;
  EXCEPTION
    WHEN OTHERS  THEN
  ROLLBACK;
  IO_STATUS := 9;
  IO_SQLERR := SQLCODE ||  SQLERRM;

  SELECT SYSDATE INTO V_END_TIMESTAMP FROM DUAL;
  P_MMAPDM_WRITE_LOGS(PROCEDURE_NAME,IO_STATUS,IO_ROW,V_START_TIMESTAMP,V_END_TIMESTAMP,IO_SQLERR);
END P_DM_CUSTOMER;
/
